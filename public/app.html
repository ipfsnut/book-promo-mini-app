<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INEVITABLE - Mini App</title>
  <meta property="og:title" content="INEVITABLE: Distributed Cognition & Network Superintelligence">
  <meta property="og:description" content="Explore the future of network superintelligence with this groundbreaking NFT book">
  <meta property="og:image" content="https://epicdylan.com/inevitable-cover.jpg">
  
  <style>
    /* Mini-app specific styles */
    body {
      padding: 0;
      margin: 0;
      background-color: #121212;
      color: #f8f8f8;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    .app-container {
      max-width: 100%;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .app-header {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .app-header h1 {
      font-size: 1.5rem;
      margin: 0;
      color: #fff;
      background: linear-gradient(to right, #4f46e5, #6b21a8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .app-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
    }
    
    .app-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .app-main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    
    .book-cover {
      width: 100%;
      max-width: 300px;
      margin: 1rem auto;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .book-cover img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .book-info {
      width: 100%;
      max-width: 500px;
      background-color: rgba(50, 50, 50, 0.5);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    .action-button {
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    
    .action-button:hover {
      background-color: #4338ca;
    }
    
    .action-button.secondary {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .action-button.secondary:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .tab-container {
      width: 100%;
      max-width: 500px;
      margin-top: 1rem;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 0.5rem;
    }
    
    .tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #aaa;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .tab.active {
      border-bottom-color: #4f46e5;
      color: #fff;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
      background-color: rgba(50, 50, 50, 0.5);
      border-radius: 8px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .token-data {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
    }
    
    .token-value {
      font-weight: bold;
    }
    
    .positive {
      color: #10b981;
    }
    
    .negative {
      color: #ef4444;
    }
    
    /* Loading screen */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #121212;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    .loading-container.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: #4f46e5;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 1rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.2rem;
      color: #fff;
    }
  </style>
  <!-- Preload the SDK script -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@farcaster/core@0.11.0/dist/index.js" as="script">
</head>
<body>
  <!-- Loading screen (will be hidden by SDK) -->
  <div class="loading-container" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading INEVITABLE...</div>
  </div>
  
  <div class="app-container">
    <header class="app-header">
      <h1>INEVITABLE</h1>
      <div class="app-logo">
        <img src="https://epicdylan.com/inevitable-icon.png" alt="INEVITABLE Logo" onerror="this.src='https://epicdylan.com/inevitable-cover.jpg'">
      </div>
    </header>
    
    <main class="app-main">
      <div class="book-cover">
        <img src="https://epicdylan.com/inevitable-cover.jpg" alt="INEVITABLE book cover" id="bookCover">
      </div>
      
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="book">Book Details</div>
          <div class="tab" data-tab="token">$NSI Token</div>
        </div>
        
        <div class="tab-content active" id="book-tab">
          <div class="book-info">
            <h2>Distributed Cognition & Network Superintelligence</h2>
            <p class="author">By EpicDylan</p>
            <p class="description">
              An exploration of distributed cognition and the future of network superintelligence. This groundbreaking NFT book examines how collective intelligence may lead to the emergence of network superintelligence.
            </p>
            
            <div class="action-buttons">
              <a href="https://www.alexandriabooks.com/collection/inevitable" class="action-button">Read on Alexandria</a>
              <a href="https://epicdylan.com/getinevitable" class="action-button secondary">Alternative Options</a>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="token-tab">
          <div class="token-info">
            <h2>$NSI Token</h2>
            <p>The Network Superintelligence memecoin represents the concepts and community behind INEVITABLE.</p>
            
            <div class="token-data-container">
              <div class="token-data">
                <span>Current Price:</span>
                <span class="token-value" id="token-price">Loading...</span>
              </div>
              <div class="token-data">
                <span>24h Change:</span>
                <span class="token-value" id="token-change">Loading...</span>
              </div>
              <div class="token-data">
                <span>Liquidity:</span>
                <span class="token-value" id="token-liquidity">Loading...</span>
              </div>
              <div class="token-data">
                <span>Volume (24h):</span>
                <span class="token-value" id="token-volume">Loading...</span>
              </div>
            </div>
            
            <div class="action-buttons">
              <a href="https://app.baseswap.fi/swap" class="action-button">Buy $NSI</a>
              <a href="https://www.nounspace.com/t/base/0x1696688A7828E227E64953C371aC0B57d5974B55/Profile" class="action-button secondary">Join Community</a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // Try to create a proxy for our calls to hide CORS issues
    const API_URL = '/.netlify/functions/token-data';
    const USE_PROXY = true; // Set to false if you want to use direct API calls
    
    // Early function to dismiss splash screen
    // Calling this as early as possible in page lifecycle
    async function dismissSplash() {
      try {
        // Dynamic import of Farcaster SDK
        const { sdk } = await import('https://cdn.jsdelivr.net/npm/@farcaster/core@0.11.0/dist/index.js');
        console.log('üîÑ Loaded Farcaster SDK, dismissing splash screen...');
        
        // Tell Farcaster we're ready to show content
        await sdk.ready();
        console.log('‚úÖ Splash screen dismissed');
        
        // Set global sdk for other functions to use
        window.farcasterSDK = sdk;
        return true;
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not load Farcaster SDK or not in Farcaster environment:', error);
        // Hide our fallback loading screen
        document.getElementById('loadingScreen').classList.add('hidden');
        return false;
      }
    }
    
    // This function exists outside of any other functions so it can run ASAP
    // The splash screen dismissal is completely separate from the rest of app init
    dismissSplash().then(success => {
      if (success) {
        console.log('‚ú® Successfully dismissed Farcaster splash screen');
      } else {
        console.log('‚ÑπÔ∏è Running in standalone mode (not in Farcaster)');
      }
    });
    
    // Main app initialization - runs in parallel with splash screen dismissal
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Initializing INEVITABLE Mini App...');
      
      // Set up tab navigation
      setupTabs();
      
      // Fetch token price data
      await fetchTokenData();
    });
    
    // Set up tab switching
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Deactivate all tabs
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Activate clicked tab
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
        });
      });
    }
    
    // Fetch token price data
    async function fetchTokenData() {
      try {
        console.log('üîç Fetching token data...');
        let response;
        
        if (USE_PROXY) {
          // Use our backend proxy to avoid CORS issues
          response = await fetch(API_URL);
        } else {
          // Direct call to the API (may have CORS issues)
          response = await fetch('https://api.dexscreener.com/latest/dex/tokens/0x1696688A7828E227E64953C371aC0B57d5974B55');
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä Token data received:', data);
        
        // Process the data
        if (data && data.pairs && data.pairs.length > 0) {
          // Sort pairs by liquidity to get the main pair
          const pairs = data.pairs.sort((a, b) => 
            parseFloat(b.liquidity?.usd || 0) - parseFloat(a.liquidity?.usd || 0)
          );
          
          const mainPair = pairs[0];
          console.log('üí∞ Using main pair:', mainPair.pairAddress);
          
          // Extract values
          const priceUsd = parseFloat(mainPair.priceUsd);
          const priceChange = parseFloat(mainPair.priceChange.h24);
          const liquidity = parseFloat(mainPair.liquidity?.usd || 0);
          const volume = parseFloat(mainPair.volume?.h24 || 0);
          
          // Update UI elements
          document.getElementById('token-price').textContent = `$${priceUsd.toFixed(8)}`;
          
          const changeEl = document.getElementById('token-change');
          changeEl.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
          changeEl.className = `token-value ${priceChange >= 0 ? 'positive' : 'negative'}`;
          
          document.getElementById('token-liquidity').textContent = `$${formatNumber(liquidity)}`;
          document.getElementById('token-volume').textContent = `$${formatNumber(volume)}`;
          
          return true;
        } else {
          console.warn('‚ö†Ô∏è No pairs found in response:', data);
          throw new Error('No valid pairs found in response');
        }
      } catch (error) {
        console.error('‚ùå Error fetching token data:', error);
        
        // Update UI with error state
        document.getElementById('token-price').textContent = 'Error loading data';
        document.getElementById('token-change').textContent = 'Error loading data';
        document.getElementById('token-liquidity').textContent = 'Error loading data';
        document.getElementById('token-volume').textContent = 'Error loading data';
        
        return false;
      }
    }
    
    // Format number with commas
    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', { 
        maximumFractionDigits: 0 
      }).format(num);
    }
  </script>
</body>
</html>